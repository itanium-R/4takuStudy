<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style><!--
    
      @import url(http://fonts.googleapis.com/earlyaccess/notosansjp.css);

      input[type="button"]{
        display    : inline-block;
        width      : 20em;  max-width   : 90vw;
        padding    : 3px;   max-padding : 2vw;
        margin     : 3px;   max-margin  : 2vw;
        background : ivory;
        color      : #000;
        border     : 0.1em solid #000;
        border-radius: 0.5em;
      }
      input[type="button"]:active{
      }
      font.correct{
        color:red;
      }
      font.incorrect{
        color:blue;
      }
      body{
        margin:0;padding:0;
        font-weight: bold; font-size:1.2em;
        font-family: 'Noto Sans JP';
      }
      div{
        margin:auto;
      }
    --></style>
    <script>
      const DEFAULT_COLOR = "ivory";
      const INCORRE_COLOR = "#f8b862";
      const CORRECT_COLOR = "#a0d8ef";
      const DISABLE_COLOR = "#CCC";
      var curA;
      var curQNum;
      var isAbleToAns  = false;
      var isAbleToNext = false;
      var nextQA;
      
      window.onload = function onload(){
        initialize();
      }
      function initialize(){
        
        document.getElementById("questionDiv").innerHTML = "";
        document.getElementById("b1").value = "loading";
        document.getElementById("b2").value = "loading";
        document.getElementById("b3").value = "loading";
        document.getElementById("b4").value = "loading";
        
        document.getElementById("navi").innerHTML = "出題くん ver 0.1";
        
        google.script.run.withSuccessHandler(result1).sendToHTML_question();
        function result1(data){
          nextQA = data;
          readQuestion();
        }
      }
      
      // 問題を読み込む
      function readQuestion(){
        hideNextButton();
        
        // nextQAにbufされた情報を表示
        document.getElementById("questionDiv").innerHTML = nextQA[0];
        var index = shuffleIndex(4);
        document.getElementById("b1").value = nextQA[index[0]+1];
        document.getElementById("b2").value = nextQA[index[1]+1];
        document.getElementById("b3").value = nextQA[index[2]+1];
        document.getElementById("b4").value = nextQA[index[3]+1];
        curA    = nextQA[1]; // 今の問題の答えを記憶
        curQNum = nextQA[5]; // 今の問題番号　を記憶
        document.getElementById("result").innerHTML="";
        showAnsButton();
        isAbleToAns=true;
        colorAnsButton(DEFAULT_COLOR);
        
      }
      
      
      // shuffleされた添え字が入る1次行列を返す函数
      function shuffleIndex(num){
        var index=[];
        for(var i=0;i<num;i++)index[i]=i;
        for(var i=0;i<num;i++){
          for(var j=0;j<num;j++){
            if(Math.random()<0.5){
              let tmp = index[i];
              index[i]=index[j];
              index[j]=tmp;
            }
          }
        }
        return index;
      }
      
      // 回答選択肢ボタンが押された時の正誤確認
      function checkAns(obj){
        if(isAbleToAns==false)return false;
        var objVal = obj.value;
        //hideAnsButton();
        colorAnsButton(DISABLE_COLOR);
        colorCorrectButton(CORRECT_COLOR);
        if(objVal==curA){
          // 正解
          google.script.run.withSuccessHandler().addCorrect(curQNum);
          document.getElementById("result").innerHTML="<font class='correct'>正解！</font>";
        }else{
          // 不正解
          google.script.run.withSuccessHandler().addIncorrect(curQNum);
          document.getElementById("result").innerHTML="<font class='incorrect'>不正解...</font>";
          obj.style.backgroundColor=INCORRE_COLOR;
        }
        isAbleToAns=false;
        
        // read next question ->nextQA
        google.script.run.withSuccessHandler(result1).sendToHTML_question();
        function result1(data){
          nextQA = data;
          showNextButton();
          isAbleToNext = true;
        }

        
      }
      
      // 正解ボタンのみarg:color色に着色
      function colorCorrectButton(color){
      for(let i=1;i<=4;i++)
          if(document.getElementById("b"+i).value==curA)
             document.getElementById("b"+i).style.backgroundColor=color;
      }
      
      // すべてのボタンをarg:color色に着色
      function colorAnsButton(color){
        for(let i=1;i<=4;i++)
          document.getElementById("b"+i).style.backgroundColor=color;
      }
      
      function hideAnsButton() {document.getElementById("ansButton" ).style.display="none";}  
      function showAnsButton() {document.getElementById("ansButton" ).style.display="block";} 
      function hideNextButton(){document.getElementById("nextButton").style.display="none";}  
      function showNextButton(){document.getElementById("nextButton").style.display="block";}  

    </script>
  </head>
  

  <body>
    
    <div id="navi"></div>
    <hr>
    
    <hr />
    <div style="height:7em;" id="questionDiv"></div>
    <hr />

    <div  style="text-align:center;">
      <div id="ansButton">
        <input type="button" id="b1" value="" onclick="checkAns(this)">
        <input type="button" id="b2" value="" onclick="checkAns(this)">
        <input type="button" id="b3" value="" onclick="checkAns(this)">
        <input type="button" id="b4" value="" onclick="checkAns(this)">
      </div>
        <hr>
        <div id="result"  style="height:1.5em;"></div>
        <hr>
        
      <div id="nextButton">
        <input type="button" id="a1" value="Next" onclick="if(isAbleToNext)readQuestion();">
      </div>
    </div>
   
  </body>
</html>
